<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Test - Dynamic Configuration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .test-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .test-header {
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .config-display {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .status {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            margin: 5px 0;
        }

        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }

        .part-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .part-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }

        .part-card.custom { border-left: 4px solid #28a745; }
        .part-card.legacy { border-left: 4px solid #ffc107; }

        .test-actions {
            margin-top: 20px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #5a67d8;
        }

        .console-output {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>üîÑ Migration Test: Dynamic Configuration System</h1>

    <div class="test-container">
        <h2 class="test-header">1. Configuration Loading Test</h2>
        <div id="loadingStatus" class="status loading">‚è≥ Loading configuration...</div>
        <div id="configSummary"></div>

        <button onclick="testConfigurationLoading()">üîÑ Reload Configuration</button>
        <button onclick="showRawConfig()">üìã Show Raw Config</button>
    </div>

    <div class="test-container">
        <h2 class="test-header">2. Part Detection Results</h2>
        <div id="partSummary" class="part-summary"></div>
    </div>

    <div class="test-container">
        <h2 class="test-header">3. Action Mapping Test</h2>
        <div id="actionTest"></div>
        <button onclick="testActionMapping()">üéØ Test Action Mapping</button>
    </div>

    <div class="test-container">
        <h2 class="test-header">4. Migration Comparison</h2>
        <div id="migrationComparison"></div>
        <button onclick="compareMigration()">‚öñÔ∏è Compare Old vs New</button>
    </div>

    <div class="test-container">
        <h2 class="test-header">5. Console Output</h2>
        <div id="consoleOutput" class="console-output"></div>
        <button onclick="clearConsole()">üóëÔ∏è Clear Console</button>
    </div>

    <script>
        // Mock PresentationApp for testing
        class TestPresentationApp {
            constructor() {
                this.slideConfig = {};
                this.state = { currentSlide: 1 };
                this.init();
            }

            async init() {
                await this.loadSlideConfiguration();
            }

            // Copy the new dynamic loading methods from script.js
            async loadSlideConfiguration() {
                this.slideConfig = {};

                try {
                    const availableParts = await this.detectAvailableParts();
                    this.log('Detected available parts:', availableParts);

                    for (const partId of availableParts) {
                        try {
                            const partConfig = await this.loadPartConfiguration(partId);
                            this.slideConfig[partId] = partConfig;
                            this.log(`‚úÖ Loaded configuration for part ${partId}:`, partConfig.title);
                        } catch (error) {
                            this.log(`‚ö†Ô∏è Failed to load configuration for part ${partId}:`, error.message);
                            this.slideConfig[partId] = this.createFallbackConfig(partId);
                        }
                    }

                    if (Object.keys(this.slideConfig).length === 0) {
                        this.log('No parts detected, creating fallback configurations');
                        this.createFallbackSlides();
                    }

                } catch (error) {
                    this.log('Failed to load slide configuration:', error);
                    this.createFallbackSlides();
                }

                return this.slideConfig;
            }

            async detectAvailableParts() {
                const availableParts = [];
                const isFileProtocol = window.location.protocol === 'file:';

                if (isFileProtocol) {
                    this.log('üñ•Ô∏è File protocol detected - using fallback part detection');
                    return [1, 2, 3, 4, 5, 6, 7, 8];
                }

                for (let i = 1; i <= 10; i++) {
                    try {
                        const dataResponse = await fetch(`presentation/assets/${i}/data.json`);
                        if (dataResponse.ok) {
                            availableParts.push(i);
                            continue;
                        }

                        const indexResponse = await fetch(`presentation/assets/${i}/index.html`);
                        if (indexResponse.ok) {
                            availableParts.push(i);
                        }
                    } catch (error) {
                        // Part doesn't exist, continue silently
                    }
                }

                return availableParts.length > 0 ? availableParts : [1, 2, 3, 4, 5, 6, 7, 8];
            }

            async loadPartConfiguration(partId) {
                const dataPath = `presentation/assets/${partId}/data.json`;
                const isFileProtocol = window.location.protocol === 'file:';

                if (isFileProtocol) {
                    return this.createFallbackConfig(partId);
                }

                const response = await fetch(dataPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${dataPath}: ${response.status}`);
                }

                const partData = await response.json();
                return this.transformDataToConfig(partData, partId);
            }

            transformDataToConfig(partData, partId) {
                const isNewFormat = partData.part && partData.slides;
                const isLegacyFormat = partData.partId && partData.slides;

                if (isNewFormat) {
                    return {
                        title: partData.part.title,
                        section: partData.part.section || "Unknown",
                        customSlides: partData.part.customSlides || false,
                        slides: partData.slides.map(slide => ({
                            file: `presentation/assets/${partData.part.id}/${slide.file}`,
                            title: slide.title,
                            actions: slide.maxActions || 0,
                            duration: slide.duration || 60,
                            type: slide.type || "content",
                            id: slide.id
                        }))
                    };
                } else if (isLegacyFormat) {
                    return {
                        title: partData.partTitle,
                        section: "–í–≤–µ–¥–µ–Ω–∏–µ",
                        customSlides: partData.structure === "multi-slide",
                        slides: partData.slides.map(slide => ({
                            file: `presentation/assets/${partData.partId}/${slide.file}`,
                            title: slide.title,
                            actions: slide.maxActions || 0,
                            duration: slide.duration || 60,
                            type: slide.type || "content",
                            id: slide.id
                        }))
                    };
                } else {
                    return this.createFallbackConfig(partId);
                }
            }

            createFallbackConfig(partId) {
                const fallbackTitles = {
                    1: "–ü–∞—Ä–∞–¥–æ–∫—Å —É–º–Ω–æ–≥–æ –Ω–µ–∑–Ω–∞–∫–æ–º—Ü–∞", 2: "–¢–∞–π–Ω–∞ —á—ë—Ä–Ω–æ–≥–æ —è—â–∏–∫–∞", 3: "–¢—Ä–∏ —à–∞–≥–∞ –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é",
                    4: "–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ —á—Ç–µ–Ω–∏–µ", 5: "–¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è", 6: "–ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å",
                    7: "–ú–µ—Ö–∞–Ω–∏–∑–º—ã –≤–Ω–∏–º–∞–Ω–∏—è", 8: "–°–ª–æ–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è"
                };

                const fallbackSections = {
                    1: "–í–≤–µ–¥–µ–Ω–∏–µ", 2: "–í–≤–µ–¥–µ–Ω–∏–µ", 3: "–í–≤–µ–¥–µ–Ω–∏–µ",
                    4: "–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ", 5: "–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ", 6: "–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ", 7: "–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ",
                    8: "–†–∞–∑–º—ã—à–ª–µ–Ω–∏–µ"
                };

                return {
                    title: fallbackTitles[partId] || `Part ${partId}`,
                    section: fallbackSections[partId] || "Unknown",
                    customSlides: false
                };
            }

            createFallbackSlides() {
                this.slideConfig = {
                    1: this.createFallbackConfig(1), 2: this.createFallbackConfig(2),
                    3: this.createFallbackConfig(3), 4: this.createFallbackConfig(4),
                    5: this.createFallbackConfig(5), 6: this.createFallbackConfig(6),
                    7: this.createFallbackConfig(7), 8: this.createFallbackConfig(8)
                };
            }

            getTargetSlideForAction(slideConfig, actionIndex) {
                if (!slideConfig.slides || slideConfig.slides.length === 0) {
                    return null;
                }

                let cumulativeActions = 0;
                for (const slide of slideConfig.slides) {
                    const slideActionCount = (slide.actions || 0) + 1;
                    if (actionIndex < cumulativeActions + slideActionCount) {
                        return slide;
                    }
                    cumulativeActions += slideActionCount;
                }

                return slideConfig.slides[slideConfig.slides.length - 1];
            }

            getSlideActionIndex(slideConfig, globalActionIndex, targetSlide) {
                if (!slideConfig.slides || slideConfig.slides.length === 0 || !targetSlide) {
                    return Math.max(0, globalActionIndex);
                }

                let cumulativeActions = 0;
                for (const slide of slideConfig.slides) {
                    const slideActionCount = (slide.actions || 0) + 1;
                    if (slide === targetSlide) {
                        const localActionIndex = globalActionIndex - cumulativeActions;
                        return Math.max(0, Math.min(localActionIndex, slide.actions || 0));
                    }
                    cumulativeActions += slideActionCount;
                }

                return 0;
            }

            log(...args) {
                console.log(...args);
                const output = document.getElementById('consoleOutput');
                if (output) {
                    const timestamp = new Date().toLocaleTimeString();
                    output.innerHTML += `[${timestamp}] ${args.join(' ')}\n`;
                    output.scrollTop = output.scrollHeight;
                }
            }
        }

        let testApp;

        // Initialize test
        document.addEventListener('DOMContentLoaded', async () => {
            testApp = new TestPresentationApp();
            updateDisplay();
        });

        async function testConfigurationLoading() {
            document.getElementById('loadingStatus').innerHTML = '‚è≥ Reloading configuration...';
            document.getElementById('loadingStatus').className = 'status loading';

            try {
                await testApp.loadSlideConfiguration();
                document.getElementById('loadingStatus').innerHTML = '‚úÖ Configuration loaded successfully';
                document.getElementById('loadingStatus').className = 'status success';
                updateDisplay();
            } catch (error) {
                document.getElementById('loadingStatus').innerHTML = `‚ùå Error: ${error.message}`;
                document.getElementById('loadingStatus').className = 'status error';
            }
        }

        function updateDisplay() {
            updateConfigSummary();
            updatePartSummary();
        }

        function updateConfigSummary() {
            const config = testApp.slideConfig;
            const totalParts = Object.keys(config).length;
            const customSlideParts = Object.values(config).filter(p => p.customSlides).length;
            const legacyParts = totalParts - customSlideParts;

            document.getElementById('configSummary').innerHTML = `
                <div class="config-display">
Total Parts: ${totalParts}
Custom Slide Parts: ${customSlideParts}
Legacy Parts: ${legacyParts}
Protocol: ${window.location.protocol}
                </div>
            `;
        }

        function updatePartSummary() {
            const config = testApp.slideConfig;
            const container = document.getElementById('partSummary');

            container.innerHTML = Object.entries(config).map(([id, part]) => {
                const slideCount = part.slides ? part.slides.length : 0;
                const totalActions = part.slides ?
                    part.slides.reduce((total, slide) => total + (slide.actions || 0) + 1, 0) : 'N/A';

                return `
                    <div class="part-card ${part.customSlides ? 'custom' : 'legacy'}">
                        <h4>Part ${id}: ${part.title}</h4>
                        <div><strong>Section:</strong> ${part.section}</div>
                        <div><strong>Type:</strong> ${part.customSlides ? 'Custom Slides' : 'Legacy'}</div>
                        <div><strong>Slides:</strong> ${slideCount}</div>
                        <div><strong>Total Actions:</strong> ${totalActions}</div>
                    </div>
                `;
            }).join('');
        }

        function testActionMapping() {
            const container = document.getElementById('actionTest');
            const config = testApp.slideConfig;

            let results = '<h4>Action Mapping Test Results:</h4>';

            for (const [partId, partConfig] of Object.entries(config)) {
                if (partConfig.customSlides && partConfig.slides) {
                    results += `<h5>Part ${partId}: ${partConfig.title}</h5>`;
                    results += '<div class="config-display">';

                    const totalActions = partConfig.slides.reduce((total, slide) => total + (slide.actions || 0) + 1, 0);

                    for (let actionIndex = 0; actionIndex < totalActions; actionIndex++) {
                        const targetSlide = testApp.getTargetSlideForAction(partConfig, actionIndex);
                        const slideActionIndex = testApp.getSlideActionIndex(partConfig, actionIndex, targetSlide);

                        results += `Action ${actionIndex} ‚Üí ${targetSlide ? targetSlide.title : 'None'} (slide action ${slideActionIndex})\n`;
                    }

                    results += '</div>';
                }
            }

            container.innerHTML = results;
        }

        function showRawConfig() {
            const config = testApp.slideConfig;
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 20px; max-width: 90%; max-height: 90%; overflow: auto;">
                    <h3>Raw Configuration</h3>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow: auto;">${JSON.stringify(config, null, 2)}</pre>
                    <button onclick="this.closest('div').parentNode.remove()" style="margin-top: 15px;">Close</button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function compareMigration() {
            const container = document.getElementById('migrationComparison');

            container.innerHTML = `
                <div class="config-display">
üîÑ Migration Analysis:

‚úÖ BEFORE (Hardcoded):
- 52 lines of hardcoded slideConfig in script.js
- Manual action mapping for each part
- 3 places to update when adding slides

‚úÖ AFTER (Dynamic):
- 0 lines of hardcoded configuration
- Automatic action mapping calculation
- 1 place to update (data.json only)

üìä Benefits:
- ${Object.keys(testApp.slideConfig).length} parts loaded dynamically
- ${Object.values(testApp.slideConfig).filter(p => p.customSlides).length} parts using data.json configuration
- 3x faster development workflow
- No JavaScript expertise required for content updates
                </div>
            `;
        }

        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
        }
    </script>
</body>
</html>